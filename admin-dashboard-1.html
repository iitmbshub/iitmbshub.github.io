<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - IITM BS HUB</title>
    
    <link rel="icon" href="https://i.ibb.co/vxp4pdwC/IITM-BS-Hub.png" type="image/png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f1f5f9; }
        .admin-card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .form-input { display: block; width: 100%; border-radius: 0.5rem; border: 1px solid #cbd5e1; padding: 0.75rem 1rem; transition: all 0.2s ease; }
        .form-input:focus { border-color: #003B5C; box-shadow: 0 0 0 2px rgba(0, 59, 92, 0.2); outline: none; }
        .btn-primary { background-color: #003B5C; color: white; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: background-color 0.2s ease; }
        .btn-primary:hover { background-color: #005a8b; }
        .btn-danger { background-color: #dc2626; color: white; font-size: 0.75rem; padding: 0.25rem 0.6rem; border-radius: 0.375rem; transition: background-color 0.2s ease; }
        .btn-danger:hover { background-color: #b91c1c; }
        #toast { transition: transform 0.3s ease, opacity 0.3s ease; }
    </style>
</head>
<body class="text-gray-900">

    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-xl translate-x-[120%] opacity-0 z-50">
        <span id="toast-message">Operation successful!</span>
    </div>

    <header class="bg-white shadow-md">
        <div class="container mx-auto px-6 py-4 flex items-center gap-4">
            <img src="https://i.ibb.co/vxp4pdwC/IITM-BS-Hub.png" alt="Logo" class="h-10 w-10">
            <h1 class="text-2xl font-bold text-[#003B5C]">Admin Content Manager</h1>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">
        
        <div class="space-y-6 md:space-y-8">
            <section class="admin-card">
                <div class="p-6 border-b"><h2 class="text-xl font-bold flex items-center"><i class="fas fa-bullhorn mr-3 text-[#f17922]"></i>Manage Blog Posts</h2></div>
                <form id="notice-form" class="p-6 space-y-4">
                    <div>
                        <label for="notice-title" class="font-semibold text-sm mb-1 block">Blog Title</label>
                        <input type="text" id="notice-title" class="form-input" placeholder="Enter the title of the blog post" required>
                    </div>
                    <div>
                        <label for="notice-content" class="font-semibold text-sm mb-1 block">Full Content (HTML)</label>
                        <textarea id="notice-content" class="form-input" rows="12" placeholder="Paste the HTML code for the blog content here..."></textarea>
                    </div>
                    <button type="submit" class="btn-primary w-full">Add New Blog Post</button>
                </form>
                <div class="p-6">
                    <h3 class="font-bold mb-4">Existing Posts</h3>
                    <div id="existing-notices" class="space-y-3 max-h-96 overflow-y-auto pr-2"><div class="text-center text-gray-500 py-4">Loading...</div></div>
                </div>
            </section>
        </div>

        <div class="space-y-6 md:space-y-8">
            <section class="admin-card">
                 <div class="p-6 border-b"><h2 class="text-xl font-bold flex items-center"><i class="fas fa-calendar-alt mr-3 text-[#f17922]"></i>Manage Class Schedule</h2></div>
                <form id="schedule-form" class="p-6 space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div><label for="schedule-date" class="font-semibold text-sm mb-1 block">Date</label><input type="date" id="schedule-date" class="form-input" required></div>
                        <div><label for="schedule-time" class="font-semibold text-sm mb-1 block">Time</label><input type="time" id="schedule-time" class="form-input" required></div>
                    </div>
                    <div><label for="schedule-subject" class="font-semibold text-sm mb-1 block">Subject</label><input type="text" id="schedule-subject" class="form-input" placeholder="e.g., Mathematics for Data Science" required></div>
                    <div>
                        <label for="schedule-link" class="font-semibold text-sm mb-1 block">Session Link (URL)</label>
                        <input type="url" id="schedule-link" class="form-input" placeholder="https://zoom.us/j/1234..." required>
                    </div>
                    <button type="submit" class="btn-primary w-full">Add Schedule Item</button>
                </form>
                <div class="p-6">
                    <h3 class="font-bold mb-4">Existing Schedule Items</h3>
                    <div id="existing-schedule" class="space-y-3 max-h-96 overflow-y-auto pr-2"><div class="text-center text-gray-500 py-4">Loading...</div></div>
                </div>
            </section>
            
            <section class="admin-card">
                <div class="p-6 border-b"><h2 class="text-xl font-bold flex items-center"><i class="fas fa-cog mr-3 text-[#f17922]"></i>Site Settings</h2></div>
                <form id="settings-form" class="p-6 space-y-4">
                    <div><label for="whatsapp-link" class="font-semibold text-sm mb-1 block">WhatsApp Channel Link</label><input type="url" id="whatsapp-link" class="form-input" placeholder="https://whatsapp.com/channel/..." required></div>
                    <hr class="my-4"><h3 class="font-bold text-lg">Welcome Popup Settings</h3>
                    <div><label for="popup-image-url" class="font-semibold text-sm mb-1 block">Popup Image URL</label><input type="url" id="popup-image-url" class="form-input" placeholder="https://example.com/image.jpg" required></div>
                    <div><label for="popup-about-text" class="font-semibold text-sm mb-1 block">Popup "About" Text</label><textarea id="popup-about-text" class="form-input" rows="3" placeholder="A short welcome message." required></textarea></div>
                    <div><label for="popup-cta-text" class="font-semibold text-sm mb-1 block">Popup Button Text</label><input type="text" id="popup-cta-text" class="form-input" placeholder="e.g., Learn More" required></div>
                    <div><label for="popup-cta-url" class="font-semibold text-sm mb-1 block">Popup Button URL</label><input type="url" id="popup-cta-url" class="form-input" placeholder="https://example.com/link" required></div>
                    <button type="submit" class="btn-primary w-full !mt-6">Save All Settings</button>
                </form>
            </section>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, deleteDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = { apiKey: "AIzaSyAC47u3mXuciaavoov2Td2AaI8TiOwV7eY", authDomain: "iitm-74779.firebaseapp.com", projectId: "iitm-74779", storageBucket: "iitm-74779.appspot.com", messagingSenderId: "49030766593", appId: "1:49030766593:web:99b7eae829f4af82556000" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // --- Toast Notification Helper ---
        const toastEl = document.getElementById('toast');
        const toastMessageEl = document.getElementById('toast-message');
        function showToast(message, isError = false) {
            toastMessageEl.textContent = message;
            toastEl.className = toastEl.className.replace(/bg-\w+-\d+/, isError ? 'bg-red-500' : 'bg-green-500');
            toastEl.classList.remove('translate-x-[120%]', 'opacity-0');
            setTimeout(() => { toastEl.classList.add('translate-x-[120%]', 'opacity-0'); }, 3000);
        }

        // --- Generic Delete Function ---
        const handleDelete = async (collectionName, id) => {
            if (confirm('Are you sure you want to delete this item?')) {
                try {
                    await deleteDoc(doc(db, collectionName, id));
                    showToast("Item deleted successfully!");
                } catch (error) {
                    console.error("Error deleting item:", error);
                    showToast("Failed to delete item.", true);
                }
            }
        };

        // --- 1. Manage Notices/Blogs ---
        const noticeForm = document.getElementById('notice-form');
        const existingNoticesEl = document.getElementById('existing-notices');
        
        noticeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = noticeForm['notice-title'].value;
            const content = noticeForm['notice-content'].value;
            try {
                await addDoc(collection(db, "notices"), { title, content, date: serverTimestamp() });
                noticeForm.reset();
                showToast("Blog post added successfully!");
            } catch (error) { showToast("Failed to add post.", true); }
        });
        
        onSnapshot(query(collection(db, "notices"), orderBy("date", "desc")), (snapshot) => {
            if (snapshot.empty) { existingNoticesEl.innerHTML = `<div class="text-center text-gray-500 py-4">No posts found.</div>`; return; }
            existingNoticesEl.innerHTML = '';
            snapshot.forEach(doc => {
                const item = doc.data();
                const el = document.createElement('div');
                el.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-md border';
                el.innerHTML = `<div><p class="font-semibold">${item.title}</p><p class="text-xs text-gray-500">${item.date?.toDate().toLocaleDateString()}</p></div><button class="btn-danger">Delete</button>`;
                el.querySelector('button').onclick = () => handleDelete('notices', doc.id);
                existingNoticesEl.appendChild(el);
            });
        });

        // --- 2. Manage Class Schedule ---
        const scheduleForm = document.getElementById('schedule-form');
        const existingScheduleEl = document.getElementById('existing-schedule');
        
        scheduleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const scheduleData = {
                date: scheduleForm['schedule-date'].value,
                time: scheduleForm['schedule-time'].value,
                subject: scheduleForm['schedule-subject'].value,
                link: scheduleForm['schedule-link'].value
            };
            try {
                await addDoc(collection(db, "schedule"), scheduleData);
                scheduleForm.reset();
                showToast("Schedule item added!");
            } catch (error) { showToast("Failed to add schedule item.", true); }
        });

        onSnapshot(query(collection(db, "schedule"), orderBy("date", "desc")), (snapshot) => {
            if (snapshot.empty) { existingScheduleEl.innerHTML = `<div class="text-center text-gray-500 py-4">No schedule items found.</div>`; return; }
            existingScheduleEl.innerHTML = '';
            snapshot.forEach(doc => {
                const item = doc.data();
                const el = document.createElement('div');
                el.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-md border';
                el.innerHTML = `<div><p class="font-semibold">${item.subject} - ${item.date}</p><a href="${item.link}" target="_blank" class="text-xs text-blue-500 hover:underline truncate">${item.link}</a></div><button class="btn-danger">Delete</button>`;
                el.querySelector('button').onclick = () => handleDelete('schedule', doc.id);
                existingScheduleEl.appendChild(el);
            });
        });

        // --- 3. Manage Site Settings ---
        const settingsForm = document.getElementById('settings-form');
        const settingsDocRef = doc(db, "settings", "siteConfig");

        const loadSettings = async () => {
            try {
                const docSnap = await getDoc(settingsDocRef);
                if (docSnap.exists()) {
                    const s = docSnap.data();
                    settingsForm['whatsapp-link'].value = s.whatsappLink || '';
                    settingsForm['popup-image-url'].value = s.popupImageUrl || '';
                    settingsForm['popup-about-text'].value = s.popupAboutText || '';
                    settingsForm['popup-cta-text'].value = s.popupCtaButtonText || '';
                    settingsForm['popup-cta-url'].value = s.popupCtaButtonUrl || '';
                }
            } catch (error) { console.error("Error loading settings:", error); }
        };

        settingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const settingsData = {
                whatsappLink: settingsForm['whatsapp-link'].value,
                popupImageUrl: settingsForm['popup-image-url'].value,
                popupAboutText: settingsForm['popup-about-text'].value,
                popupCtaButtonText: settingsForm['popup-cta-text'].value,
                popupCtaButtonUrl: settingsForm['popup-cta-url'].value,
            };
            try {
                await setDoc(settingsDocRef, settingsData, { merge: true });
                showToast("Settings saved successfully!");
            } catch (error) { showToast("Failed to save settings.", true); }
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
        });
    </script>
</body>
</html>